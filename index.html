<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050510">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/images/logo.jpeg">
    <title>Neon Zen: Final Fixed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

        /* --- GLOBAL & LAYOUT --- */
        body { 
            margin: 0; overflow: hidden; background-color: #000; 
            font-family: 'Rajdhani', sans-serif; touch-action: none; user-select: none; 
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }

        #app-container {
            width: 100%; max-width: 450px; height: 100%; max-height: 900px;
            position: relative; background: #050510; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 242, 96, 0.1); border: 1px solid #111;
        }

        canvas { display: block; width: 100%; height: 100%; z-index: 1; }

        /* --- UI LAYERS --- */
        .layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 10; 
        }
        .hidden { display: none !important; }

        /* --- LOADING SCREEN --- */
        #screen-init { background: #000; z-index: 300; pointer-events: auto; cursor: pointer; }
        #screen-loading { background: #000; z-index: 200; pointer-events: auto; transition: opacity 0.5s; }
        
        .logo-img { 
            width: 160px; height: 160px; border-radius: 50%; object-fit: cover;
            box-shadow: 0 0 40px #00f260; animation: pulseLogo 2s infinite; margin-bottom: 20px;
        }
        .loading-track { width: 70%; height: 4px; background: #222; margin-top: 30px; border-radius: 2px; overflow: hidden; }
        .loading-bar { width: 0%; height: 100%; background: #00f260; box-shadow: 0 0 10px #00f260; transition: width 0.1s; }
        
        @keyframes pulseLogo { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 60px #00f260; } 100% { transform: scale(1); } }
        .blink-text { color: #00f260; font-family: 'Orbitron'; animation: blink 1s infinite; margin-top: 20px; letter-spacing: 2px; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* --- MENUS --- */
        .menu { 
            background: rgba(5,5,16,0.95); width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            pointer-events: auto; backdrop-filter: blur(10px);
        }
        h1 { font-family: 'Orbitron'; font-size: 3rem; color: white; margin: 0 0 10px 0; text-shadow: 0 0 20px #00f260; text-align: center; }
        
        .btn { 
            background: linear-gradient(90deg, #00f260, #00c6ff); 
            color: #000; font-family: 'Orbitron'; font-weight: bold; 
            padding: 15px 50px; font-size: 1.2rem; border: none; border-radius: 50px; 
            cursor: pointer; margin: 10px; box-shadow: 0 0 20px rgba(0,242,96,0.5); 
            transition: transform 0.1s; text-transform: uppercase;
        }
        .btn:active { transform: scale(0.95); }
        .btn-outline { background: transparent; border: 2px solid #00f260; color: #00f260; box-shadow: none; }

        /* --- HUD --- */
        #screen-hud { justify-content: flex-start; padding-top: 20px; background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent 30%); }
        .hud-header { width: 90%; display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        
        .stat-box { text-align: center; color: white; flex: 1; }
        .stat-label { font-size: 0.7rem; color: #888; letter-spacing: 2px; }
        .stat-val { font-family: 'Orbitron'; font-size: 1.8rem; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .target-box .stat-val { color: #00f260; }
        
        .progress-container { width: 90%; margin-top: 5px; }
        .prog-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        .prog-fill { height: 100%; background: #00f260; width: 0%; border-radius: 3px; transition: width 0.3s; box-shadow: 0 0 10px #00f260; }

        .energy-bar-wrap { width: 90%; height: 4px; background: #333; margin-top: 5px; border-radius: 2px; }
        .energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff00cc, #3333ff); box-shadow: 0 0 10px #ff00cc; transition: width 0.1s; }

        /* FOOTER - FIXED POSITION */
        .footer { 
            position: absolute; bottom: 30px; width: 100%; 
            display: flex; justify-content: center; gap: 30px; 
            pointer-events: auto; z-index: 100; 
        }
        .pwr-btn { 
            width: 70px; height: 70px; border-radius: 50%; 
            border: 2px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.9); 
            color: white; font-size: 1.4rem; display: flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer; transition: 0.2s;
        }
        .pwr-btn:active { transform: scale(0.9); border-color: #00f260; color: #00f260; }
        .badge { position: absolute; top: -5px; right: -5px; background: #ff0044; width: 22px; height: 22px; border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; border: 2px solid white; }

        /* --- ANIMATIONS --- */
        .float-text { 
            position: absolute; font-weight: bold; pointer-events: none; 
            animation: floatUp 1s forwards; color: white; 
            text-shadow: 0 0 5px black; font-size: 1.5rem; z-index: 500; 
        }
        @keyframes floatUp { to { transform: translateY(-80px); opacity: 0; } }

        /* TRANCE & OVERLAYS */
        #trance-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; box-shadow: inset 0 0 100px #ffd700; opacity: 0; transition: opacity 0.5s; z-index: 5; mix-blend-mode: overlay; }
        .trance-active { opacity: 1 !important; }
        #trance-text { position: absolute; top: 130px; width: 100%; text-align: center; color: gold; font-family: 'Orbitron'; font-size: 1.2rem; letter-spacing: 5px; opacity: 0; transition: opacity 0.3s; }

        /* SHOP GRID */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-height: 50vh; overflow-y: auto; margin: 20px 0; }
        .shop-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; text-align: center; }
        .shop-item:active { border-color: #00f260; background: rgba(0,242,96,0.1); }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="screen-init" class="layer" onclick="App.initAudio()">
        <img src="assets/images/logo.jpeg" class="logo-img" alt="Logo">
        <div class="blink-text">TAP TO START</div>
    </div>

    <div id="screen-loading" class="layer hidden">
        <img src="assets/images/logo.jpeg" class="logo-img" alt="Logo">
        <div style="font-family:'Orbitron'; font-size:1.5rem; color:white;">TUX-TALK <span style="color:#00f260">GAMING</span></div>
        <div class="loading-track"><div class="loading-bar" id="load-bar"></div></div>
    </div>

    <div id="screen-menu" class="layer hidden">
        <div class="menu">
            <h1>NEON ZEN</h1>
            <p style="color:#aaa; margin-top:-5px;">ULTIMATE EDITION</p>
            <div style="margin: 20px 0; font-size: 1.2rem; color: #00f260; font-family:'Orbitron';">LEVEL <span id="menu-level">1</span></div>
            <button class="btn" onclick="Game.startLevel()">PLAY</button>
            <button class="btn btn-outline" onclick="UI.showShop()">SHOP</button>
        </div>
    </div>

    <div id="screen-hud" class="layer hidden">
        <div class="hud-header">
            <div class="stat-box"><div class="stat-label">SCORE</div><div class="stat-val" id="hud-score">0</div></div>
            <div class="stat-box target-box"><div class="stat-label">TARGET</div><div class="stat-val" id="hud-target">1000</div></div>
            <div class="stat-box"><div class="stat-label">MOVES</div><div class="stat-val" id="hud-moves" style="color:#00c6ff">25</div></div>
        </div>
        
        <div class="progress-container">
            <div class="prog-track"><div class="prog-fill" id="hud-progress"></div></div>
        </div>
        <div class="energy-bar-wrap"><div class="energy-fill" id="energy-bar"></div></div>
        <div id="trance-text">TRANCE MODE</div>

        <div class="footer">
            <div class="pwr-btn" onclick="Game.activatePower('bomb')">
                <i class="fas fa-bomb"></i><span class="badge" id="badge-bomb">3</span>
            </div>
            <div class="pwr-btn" onclick="Game.activatePower('hammer')">
                <i class="fas fa-hammer"></i><span class="badge" id="badge-hammer">1</span>
            </div>
            <div class="pwr-btn" onclick="Game.quitGame()" style="border-color:#ff4444; color:#ff4444;">
                <i class="fas fa-home"></i>
            </div>
        </div>
    </div>
    
    <div id="trance-overlay"></div>

    <div id="screen-win" class="layer hidden">
        <div class="menu">
            <h1 style="color:#00f260">VICTORY!</h1>
            <p style="color:white; font-size:1.2rem;">Target Reached</p>
            <h2 id="win-score" style="color:white; margin:10px 0; font-family:'Orbitron'">0</h2>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-outline" onclick="UI.showMenu()">HOME</button>
                <button class="btn" onclick="Game.nextLevel()">NEXT LEVEL</button>
            </div>
        </div>
    </div>

    <div id="screen-over" class="layer hidden">
        <div class="menu">
            <h1 style="color:#ff4444">GAME OVER</h1>
            <p style="color:white;">Out of Moves</p>
            <button class="btn" onclick="Game.retry()">RETRY</button>
            <button class="btn btn-outline" onclick="UI.showMenu()">HOME</button>
        </div>
    </div>

    <div id="screen-shop" class="layer hidden">
        <div class="menu">
            <h2>ITEM SHOP</h2>
            <p>Coins: <span id="shop-coins" style="color:gold">0</span></p>
            <div class="shop-grid" id="shop-grid"></div>
            <button class="btn btn-outline" onclick="UI.showMenu()" style="margin-top:20px;">BACK</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

</div>

<script>
    /* ----------------------------------------------------------------
       1. AUDIO CONTROLLER
    ---------------------------------------------------------------- */
    const AudioController = {
        ctx: null,
        init: function() { try { const AC = window.AudioContext || window.webkitAudioContext; if(AC){this.ctx = new AC();} } catch(e){} },
        playIntro: function() {
            if(!this.ctx) return;
            const now = this.ctx.currentTime;
            [261, 329, 392, 523, 392, 329].forEach((freq, i) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(freq, now + i*0.2);
                gain.gain.setValueAtTime(0.1, now + i*0.2); gain.gain.exponentialRampToValueAtTime(0.01, now + i*0.2 + 0.3);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(now + i*0.2); osc.stop(now + i*0.2 + 0.3);
            });
        },
        playTone: function(len) {
            if(!this.ctx) return;
            const freq = 220 * Math.pow(1.059, len);
            const t = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination); o.type='triangle';
            o.frequency.setValueAtTime(freq, t); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.2);
            o.start(); o.stop(t+0.2);
        },
        playSFX: function(type) {
            if(!this.ctx) return;
            const t = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);
            if(type==='win') { o.type='square'; o.frequency.setValueAtTime(440, t); o.frequency.linearRampToValueAtTime(880, t+0.5); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.5); }
            else if(type==='boom') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.5); g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.5); }
            o.start(); o.stop(t+0.5);
        }
    };

    /* ----------------------------------------------------------------
       2. DATA CONTROLLER
    ---------------------------------------------------------------- */
    const Data = {
        level: 1, score: 0, coins: 100, 
        powerups: { bomb: 3, hammer: 2 },
        save: function() { localStorage.setItem('nz_ultimate_fix', JSON.stringify(this)); },
        load: function() { const s = JSON.parse(localStorage.getItem('nz_ultimate_fix')); if(s) Object.assign(this, s); }
    };

    /* ----------------------------------------------------------------
       3. CONFIG & ENGINE
    ---------------------------------------------------------------- */
    // FIX: DISTINCT COLORS (No Gradients)
    const DISTINCT_COLORS = ['#D32F2F', '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0'];

    const Game = {
        canvas: document.getElementById('canvas'),
        ctx: document.getElementById('canvas').getContext('2d'),
        width: 0, height: 0,
        grid: [], particles: [], chain: [], projectiles: [],
        cols: 6, rows: 8, size: 0, startX:0, startY:0,
        
        state: 'INIT', isDragging: false, activePower: null,
        moves: 0, target: 0, currentScore: 0,
        
        // Advanced Features (Restored)
        energy: 0, isTrance: false, bgOffset: 0, pulse: 0,

        init: function() {
            this.resize(); window.addEventListener('resize', () => this.resize());
            
            const handleStart = (x,y) => this.inputStart(x,y);
            const handleMove = (x,y) => this.inputMove(x,y);
            const handleEnd = () => this.inputEnd();

            this.canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
            this.canvas.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', handleEnd);
            
            this.canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            this.canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            window.addEventListener('touchend', handleEnd);

            Data.load();
            requestAnimationFrame(() => this.loop());
        },

        resize: function() {
            const cont = document.getElementById('app-container');
            this.width = cont.clientWidth;
            this.height = cont.clientHeight;
            this.canvas.width = this.width;
            this.canvas.height = this.height;
            if(this.state === 'PLAY') this.calcGrid();
        },

        startLevel: function() {
            UI.showScreen('screen-hud');
            this.state = 'PLAY';
            this.chain = [];
            this.currentScore = 0;
            this.energy = 0; this.isTrance = false;
            
            // Level Logic
            this.target = 500 + (Data.level * 250);
            this.moves = Math.max(15, 25 - Math.floor(Data.level/5));
            
            this.calcGrid();
            this.spawnGrid();
            UI.updateHUD();
        },

        calcGrid: function() {
            this.cols = 6;
            this.size = (this.width - 20) / this.cols;
            // FIX: INCREASE FOOTER SPACE (360px)
            this.rows = Math.floor((this.height - 360) / this.size); 
            this.startX = 10;
            this.startY = 170;
        },

        spawnGrid: function() {
            this.grid = [];
            for(let r=0; r<this.rows; r++) {
                for(let c=0; c<this.cols; c++) {
                    const color = DISTINCT_COLORS[Math.floor(Math.random() * DISTINCT_COLORS.length)];
                    const type = (Math.random() < 0.05) ? 'bomb' : 'normal';
                    this.grid.push({
                        r, c, x: this.startX + c*this.size, y: this.startY + r*this.size,
                        w: this.size-6, h: this.size-6,
                        color: color, type: type,
                        active: true, scale: 0
                    });
                }
            }
        },

        getBlock: function(x, y) {
            const rect = this.canvas.getBoundingClientRect();
            const tx = x - rect.left; const ty = y - rect.top;
            return this.grid.find(b => b.active && tx > b.x && tx < b.x+b.w && ty > b.y && ty < b.y+b.h);
        },

        inputStart: function(x, y) {
            if(this.state !== 'PLAY') return;
            const b = this.getBlock(x, y);
            
            if(this.activePower && b) {
                this.triggerPower(b);
                return;
            }

            if(b) {
                if(b.type === 'bomb') { this.gameOver("EXPLODED!"); return; }
                this.isDragging = true;
                this.chain = [b];
                AudioController.playTone(0);
            }
        },

        inputMove: function(x, y) {
            if(!this.isDragging) return;
            const b = this.getBlock(x, y);
            if(b && this.chain.length > 0) {
                const last = this.chain[this.chain.length-1];
                if(b !== last && !this.chain.includes(b)) {
                    // EXACT COLOR MATCH
                    if(b.color === last.color && b.type !== 'bomb') {
                        if(Math.abs(b.r-last.r)<=1 && Math.abs(b.c-last.c)<=1) {
                            this.chain.push(b);
                            AudioController.playTone(this.chain.length);
                        }
                    }
                }
            }
        },

        inputEnd: function() {
            this.isDragging = false;
            if(this.chain.length >= 3) {
                const score = this.chain.length * 10;
                this.currentScore += score;
                this.moves--;
                Data.coins += Math.floor(score/20);
                
                // Trance & Drones (Restored Features)
                if(!this.isTrance) {
                    this.energy += 10;
                    if(this.energy >= 100) this.activateTrance();
                }
                if(this.chain.length > 5) {
                    const last = this.chain[this.chain.length-1];
                    this.projectiles.push({x: last.x, y: last.y, targetY: 0, color: last.color});
                }
                
                UI.spawnFloatText(`+${score}`, this.chain[this.chain.length-1].x, this.chain[this.chain.length-1].y);
                
                // Remove blocks
                this.chain.forEach(b => {
                    b.active = false;
                    this.spawnParticles(b.x+b.w/2, b.y+b.h/2, b.color);
                });

                // Refill
                setTimeout(() => {
                    this.chain.forEach(b => {
                        b.active = true; b.scale = 0;
                        b.type = (Math.random() < 0.05) ? 'bomb' : 'normal';
                        b.color = this.isTrance ? '#FFD700' : DISTINCT_COLORS[Math.floor(Math.random() * DISTINCT_COLORS.length)];
                    });
                    this.chain = [];
                    this.checkWinLoss();
                }, 300);
            } else {
                this.chain = [];
            }
            UI.updateHUD();
        },

        activateTrance: function() {
            this.isTrance = true;
            document.getElementById('trance-text').style.opacity = 1;
            document.getElementById('trance-overlay').classList.add('trance-active');
            this.grid.forEach(b => { if(b.active) b.color = '#FFD700'; });
        },

        checkWinLoss: function() {
            if(this.currentScore >= this.target) {
                // WIN
                this.state = 'WIN';
                AudioController.playSFX('win');
                this.blastBoard(); // Blast Animation
                setTimeout(() => UI.showWin(), 1500);
            } else if(this.moves <= 0) {
                // LOSE
                this.state = 'OVER';
                setTimeout(() => UI.showScreen('screen-over'), 500);
            }
        },

        blastBoard: function() {
            this.grid.forEach(b => {
                if(b.active) {
                    b.active = false;
                    this.spawnParticles(b.x+b.w/2, b.y+b.h/2, b.color);
                }
            });
        },

        spawnParticles: function(x, y, color) {
            for(let i=0; i<8; i++) {
                this.particles.push({
                    x, y, 
                    vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
                    life: 1.0, color: color
                });
            }
        },

        activatePower: function(type) {
            if(Data.powerups[type] > 0) {
                this.activePower = type;
                UI.spawnFloatText(type.toUpperCase() + " ACTIVE!", this.width/2, this.height/2);
            }
        },

        triggerPower: function(b) {
            if(this.activePower === 'bomb') {
                AudioController.playSFX('boom');
                this.grid.forEach(t => {
                    const d = Math.sqrt((t.x-b.x)**2 + (t.y-b.y)**2);
                    if(d < 150 && t.active) {
                        t.active = false; this.spawnParticles(t.x, t.y, t.color);
                    }
                });
                this.currentScore += 100;
                Data.powerups.bomb--;
            } else if(this.activePower === 'hammer') {
                if(b.active) {
                    b.active = false; this.spawnParticles(b.x, b.y, b.color);
                    this.currentScore += 50;
                    Data.powerups.hammer--;
                }
            }
            this.activePower = null;
            setTimeout(() => {
                this.grid.forEach(t => { if(!t.active) { t.active=true; t.scale=0; t.color = DISTINCT_COLORS[Math.floor(Math.random()*DISTINCT_COLORS.length)]; } });
                this.checkWinLoss();
            }, 500);
            UI.updateHUD();
        },

        nextLevel: function() { Data.level++; Data.save(); this.startLevel(); },
        retry: function() { this.startLevel(); },
        quitGame: function() { UI.showMenu(); },

        loop: function() {
            // Pulse Animation
            this.pulse = Math.sin(Date.now() / 200) * 2;
            this.bgOffset += 0.5; if(this.bgOffset > 40) this.bgOffset = 0;

            // Clear
            this.ctx.fillStyle = '#050510';
            this.ctx.fillRect(0,0,this.width, this.height);

            // Draw Background Grid (Moving)
            this.ctx.strokeStyle = 'rgba(0, 242, 96, 0.1)';
            this.ctx.lineWidth = 1;
            for(let x=0; x<=this.width; x+=40) { this.ctx.beginPath(); this.ctx.moveTo(x,0); this.ctx.lineTo(x,this.height); this.ctx.stroke(); }
            for(let y=this.bgOffset; y<=this.height; y+=40) { this.ctx.beginPath(); this.ctx.moveTo(0,y); this.ctx.lineTo(this.width,y); this.ctx.stroke(); }

            // Logic: Trance decay
            if(this.state === 'PLAY' && this.isTrance) {
                this.energy -= 0.2;
                document.getElementById('energy-bar').style.width = this.energy + "%";
                if(this.energy <= 0) {
                    this.isTrance = false;
                    document.getElementById('trance-overlay').classList.remove('trance-active');
                    document.getElementById('trance-text').style.opacity = 0;
                    // Reset colors
                    this.grid.forEach(b => b.color = DISTINCT_COLORS[Math.floor(Math.random()*DISTINCT_COLORS.length)]);
                }
            }

            // Draw Blocks
            if(this.state !== 'MENU' && this.state !== 'INIT') {
                // Line
                if(this.chain.length > 1) {
                    this.ctx.beginPath();
                    this.ctx.strokeStyle = 'white'; this.ctx.lineWidth = 4;
                    this.ctx.moveTo(this.chain[0].x+this.chain[0].w/2, this.chain[0].y+this.chain[0].h/2);
                    for(let i=1; i<this.chain.length; i++) this.ctx.lineTo(this.chain[i].x+this.chain[i].w/2, this.chain[i].y+this.chain[i].h/2);
                    this.ctx.stroke();
                }

                this.grid.forEach(b => {
                    if(!b.active) return;
                    if(b.scale < 1) b.scale += 0.1;
                    
                    const cx = b.x + b.w/2; const cy = b.y + b.h/2;
                    const size = (b.w * b.scale / 2) + this.pulse;

                    // GLOW REMOVED (Matte)
                    this.ctx.shadowBlur = 0; 
                    this.ctx.fillStyle = b.color;
                    
                    this.ctx.beginPath();
                    if(b.type === 'bomb') {
                        this.ctx.rect(cx-size, cy-size, size*2, size*2);
                        this.ctx.fill();
                        this.ctx.fillStyle = 'black'; this.ctx.font="20px Arial"; this.ctx.textAlign="center"; this.ctx.textBaseline="middle"; this.ctx.fillText("ðŸ’£", cx, cy);
                    } else {
                        this.ctx.arc(cx, cy, Math.max(0, size), 0, Math.PI*2);
                        this.ctx.fill();
                        // Inner White (Matte)
                        this.ctx.fillStyle = 'rgba(255,255,255,0.3)'; 
                        this.ctx.beginPath(); this.ctx.arc(cx, cy, size*0.4, 0, Math.PI*2); this.ctx.fill();
                    }
                });

                // Drones/Projectiles (Simplified Visual)
                this.projectiles.forEach((p, i) => {
                    p.y -= 10; if(p.y < 0) this.projectiles.splice(i, 1);
                    this.ctx.fillStyle = p.color; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 5, 0, Math.PI*2); this.ctx.fill();
                });
            }

            // Particles
            for(let i=this.particles.length-1; i>=0; i--) {
                let p = this.particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if(p.life <= 0) { this.particles.splice(i,1); continue; }
                this.ctx.globalAlpha = p.life;
                this.ctx.fillStyle = p.color;
                this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 4, 0, Math.PI*2); this.ctx.fill();
            }
            this.ctx.globalAlpha = 1;

            requestAnimationFrame(() => this.loop());
        }
    };

    /* ----------------------------------------------------------------
       4. UI CONTROLLER
    ---------------------------------------------------------------- */
    const UI = {
        screens: ['screen-init', 'screen-loading', 'screen-menu', 'screen-hud', 'screen-win', 'screen-over', 'screen-shop'],
        showScreen: function(id) {
            document.querySelectorAll('.layer').forEach(l => l.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'screen-menu') document.getElementById('menu-level').innerText = Data.level;
        },
        showMenu: function() { this.showScreen('screen-menu'); },
        showShop: function() { this.showScreen('screen-shop'); this.renderShop(); },
        showWin: function() { 
            this.showScreen('screen-win'); 
            document.getElementById('win-score').innerText = Game.currentScore;
        },
        updateHUD: function() {
            document.getElementById('hud-score').innerText = Game.currentScore;
            document.getElementById('hud-target').innerText = Game.target;
            document.getElementById('hud-moves').innerText = Game.moves;
            document.getElementById('badge-bomb').innerText = Data.powerups.bomb;
            document.getElementById('badge-hammer').innerText = Data.powerups.hammer;
            
            const pct = Math.min(100, (Game.currentScore / Game.target) * 100);
            document.getElementById('hud-progress').style.width = pct + "%";
        },
        spawnFloatText: function(txt, x, y) {
            const container = document.getElementById('app-container');
            const el = document.createElement('div');
            el.className = 'float-text';
            el.innerText = txt;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            container.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        },
        // FIX: RENDER POWERUPS
        renderShop: function() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            document.getElementById('shop-coins').innerText = Data.coins;
            
            const items = [
                { id: 'bomb', name: 'MEGA BOMB', price: 50, icon: 'fa-bomb' },
                { id: 'hammer', name: 'HAMMER', price: 50, icon: 'fa-hammer' }
            ];

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'shop-item';
                el.innerHTML = `
                    <div class="shop-icon"><i class="fas ${item.icon}"></i></div>
                    <h3 style="margin:0;color:white">${item.name}</h3>
                    <p class="shop-price">${item.price} <i class="fas fa-coins"></i></p>
                `;
                el.onclick = () => {
                    if(Data.coins >= item.price) {
                        Data.coins -= item.price;
                        Data.powerups[item.id]++;
                        Data.save();
                        this.renderShop();
                        alert("Purchased " + item.name + "!");
                    } else {
                        alert("Need more coins!");
                    }
                };
                grid.appendChild(el);
            });
        }
    };

    /* ----------------------------------------------------------------
       5. APP ORCHESTRATOR
    ---------------------------------------------------------------- */
    const App = {
        initAudio: function() {
            AudioController.init();
            AudioController.playIntro();
            
            // Switch to Loading
            document.getElementById('screen-init').classList.add('hidden');
            document.getElementById('screen-loading').classList.remove('hidden');
            
            // Animate Loading Bar
            let width = 0;
            const bar = document.getElementById('load-bar');
            const interval = setInterval(() => {
                width += 2;
                bar.style.width = width + "%";
                if(width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => UI.showMenu(), 500);
                }
            }, 30);
        }
    };

    // Attach to window to avoid reference errors
    window.Game = Game;
    window.UI = UI;
    window.App = App;
    window.AudioController = AudioController;
    window.Data = Data;
    
    // Start Engine
    Game.init();
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js'));
    }
</script>
</body>
</html>